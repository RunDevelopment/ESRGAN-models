# Normals

This directory contains models for upscaling normal maps.

## Models

### 4x-Normal-RG0-BC1

```
Name: 4x-Normal-RG0-BC1
Model Architecture: ESRGAN
Scale: 4
Purpose: A 4x upscaler for BC1-compressed normal maps with a zeroed-out B channel.

Iteration: 100k
batch_size: 8
HR_size: 128
Epoch: 89
Dataset: Custom. See below.
Dataset_size: 577
Pretrained_Model_G: 4x-Normal-RG0-BC1-alpha-320k.pth
```

Description: A 4x upscaler for BC1-compressed normal maps with a zeroed-out B channel.
The output normals will also have a constant-zero B channel. Use external software or image editing plugins to properly normalize the generated normals and generate the Z component (if necessary). Do no rely on this network producing unit vectors.
The LR have been compressed with various BC1 compression settings (dithering, weighting) using Texconv version 2021.11.8.1. Since the contents of the B channel influence the R and G channels during compression, the LR were given a B channel that was either the Z component of the normal, a random constant color, or a random texture (usually the G channel of the associated albedo) before compression. The LR + B channel was then compressed and the resulting BC1-compressed DDS was converted back into a PNG and had its B channel zeroed out.

### 4x-Normal-RG0-BC7

```
Name: 4xNormal-RG0-BC7
Model Architecture: ESRGAN
Scale: 4
Purpose: A 4x upscaler for BC7-compressed normal maps with a zeroed-out B channel and no alpha.

Iteration: 100k
batch_size: 8
HR_size: 128
Epoch: 89
Dataset: Custom. See below.
Dataset_size: 577
Pretrained_Model_G: 4x-Normal-RG0-alpha-350k.pth
```

Description: A 4x upscaler for BC7-compressed normal maps with a zeroed-out B channel and no alpha.
The input is required to have no alpha and constant-zero blue channel. BC7-compressed images with an alpha channel should be handled by the BC1 model instead. This is because BC7 achieves very different quality for images with and without an alpha channel.
The output normals will also have a constant-zero B channel. Use external software or image editing plugins to properly normalize the generated normals and generate the Z component (if necessary). Do no rely on this network producing unit vectors.
The LR have been compressed using Texconv version 2021.11.8.1. Since the contents of the B channel influence the R and G channels during compression, the LR were given a B channel that was either the Z component of the normal, a random constant color, or a random texture (usually the G channel of the associated albedo) before compression. The LR + B channel was then compressed and the resulting BC7-compressed DDS was converted back into a PNG and had its B channel zeroed out.

### 4x-Normal-RG0

```
Name: 4x-Normal-RG0
Model Architecture: ESRGAN
Scale: 4
Purpose: A 4x upscaler for uncompressed normal maps with a zeroed-out B channel.

Iteration: 100k
batch_size: 8
HR_size: 128
Epoch: 89
Dataset: Custom. See below.
Dataset_size: 577
Pretrained_Model_G: 4x-Normal-RG0-alpha-350k.pth
```

Description: A 4x upscaler for uncompressed normal maps with a zeroed-out B channel.
The input is required to have no alpha and constant-zero blue channel. The model can handle some light compression artifacts but has trouble with quantization artifacts.
The output normals will also have a constant-zero B channel. Use external software or image editing plugins to properly normalize the generated normals and generate the Z component (if necessary). Do no rely on this network producing unit vectors.
The LR have been generated by simply downscaling the HR.

## Early models

This list contains early versions (alpha versions) of the final models. I only included them for completeness, don't actually use those.

<details>
<summary>Show alpha versions</summary>

### 4x-Normal-RG0-BC1-alpha-320k

```
Name: 4x-Normal-RG0-BC1-alpha-320k
Model Architecture: ESRGAN
Scale: 4
Purpose: A 4x upscaler for BC1-compressed normal maps with a zeroed-out B channel.

Iteration: 320k
batch_size: 8
HR_size: 128
Epoch: 240
Dataset: Custom. See below.
Dataset_size: 577
Pretrained_Model_G: 4xESRGAN.pth
```

Description: A 4x upscaler for BC1-compressed normal maps with a zeroed-out B channel.
The output normals will also have a constant-zero B channel. Use external software or image editing plugins to properly normalize the generated normals and generate the Z component (if necessary). Do no rely on this network producing unit vectors.
The LR have been compressed with various BC1 compression settings (dithering, weighting) using Texconv version 2021.11.8.1. Since the contents of the B channel influence the R and G channels during compression, the LR were given a B channel that was either the Z component of the normal, a random constant color, or a random texture (usually the G channel of the associated albedo) before compression. The LR + B channel was then compressed and the resulting BC1-compressed DDS was converted back into a PNG and had its B channel zeroed out.

### 4x-Normal-RG0-alpha-350k

```
Name: 4x-Normal-RG0-alpha-350k
Model Architecture: ESRGAN
Scale: 4
Purpose: A 4x upscaler for uncompressed normal maps with a zeroed-out B channel.

Iteration: 350k
batch_size: 8
HR_size: 128
Epoch: 260
Dataset: Custom. See below.
Dataset_size: 577
Pretrained_Model_G: 4xESRGAN.pth
```

Description: A 4x upscaler for uncompressed normal maps with a zeroed-out B channel.
The input is required to have no alpha and constant-zero blue channel. The model can handle some light compression artifacts but has trouble with quantization artifacts.
The output normals will also have a constant-zero B channel. Use external software or image editing plugins to properly normalize the generated normals and generate the Z component (if necessary). Do no rely on this network producing unit vectors.
The LR have been generated by simply downscaling the HR.

</details>

## RG0

All of my models for upscaling normals are intended for RG0 images. RG0 means that the R channel contains the X component of the normal, the G channel contains the Y component of the normal, and the B channel is constant zero.

Most image editing programs has way to zero-out the B channel of an image. To apply this change to multiple images, use ImageMagick or PhotoShop batch actions.

Depending on your application, you might need to reconstruct the Z component of the normal and store it in the B channel. Many image editing programs after plugins to do this. If none are available, you'll have to implement this yourself. The code should be equivalent to the following GLSL function:

```glsl
vec3 normalize_rg0(vec2 rgInput) {
	float zSq = 1.0 - dot(rgInput, rgInput);
	if (zSq >= 0.0) {
		return vec3(rgInput, sqrt(zSq));
	} else {
		return vec3(rgInput / sqrt(zSq), 0.0);
	}
}
```

### Why?

I chose this weird format because the B channel of many normals is either an incorrectly computed Z component, used for something else, or just missing (some constant value). So the model has to ignore the B channel to properly upscale normals. I originally though that the model could just learn to ignore the B channel but this didn't work out, and I couldn't figure out to make a model that only processes 2 color channels.

So this is why the model needs RG0 as input, but why does it also output RG0? I originally trained a model that would take an RG0 normal map and produce a RGB (XYZ) normal map. This didn't work out. The model had real problems understanding that _Z=sqrt(1-X²-Y²)_ and didn't produce good normals in general. So I gave up on full normals and went with RG0 as the output format. Using RG0 as the output format also makes it clear that the upscaled normal map can't be used without normalization.


## Data sources

The model in this directory were trained on normals from the following sources:

- https://github.com/JosephtheKP/sourceengine_tga_archive commit:e87d6b0c62672dafcca0af94f0dfbd20487e80d3
- https://polyhaven.com/
- https://freepbr.com/
- https://ambientcg.com/
